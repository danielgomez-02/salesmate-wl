<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesmate Billing Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0f1117;
            --card: #1a1d27;
            --border: #2a2d3a;
            --text: #e4e4e7;
            --muted: #8b8d97;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #eab308;
            --blue: #3b82f6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }
        .container { max-width: 1280px; margin: 0 auto; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }
        h1 { font-size: 24px; font-weight: 700; }
        h1 span { color: var(--accent-light); }
        .filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filters label { font-size: 13px; color: var(--muted); }
        .filters input, .filters select {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        .filters button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .filters button:hover { opacity: 0.85; }

        /* KPI Row */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .kpi-card .label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--muted);
            margin-bottom: 8px;
        }
        .kpi-card .value {
            font-size: 28px;
            font-weight: 700;
        }
        .kpi-card .sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }
        .kpi-card.cost .value { color: var(--yellow); }
        .kpi-card.pass .value { color: var(--green); }
        .kpi-card.fail .value { color: var(--red); }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .chart-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--muted);
        }
        .chart-card canvas { max-height: 300px; }

        /* Table */
        .table-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }
        .table-card h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--muted);
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--muted);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        tr:hover td { background: rgba(99, 102, 241, 0.05); }
        td.cost { color: var(--yellow); font-weight: 600; }
        td.num { font-variant-numeric: tabular-nums; }

        /* Loading / Error */
        .loading-state, .error-state {
            text-align: center;
            padding: 80px 20px;
        }
        .loading-state .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-state { color: var(--red); }
        .error-state button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 12px;
        }

        footer {
            text-align: center;
            padding: 24px 0;
            font-size: 12px;
            color: var(--muted);
        }

        /* Setup modal */
        .setup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .setup-modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            width: 440px;
            max-width: 90vw;
        }
        .setup-modal h2 { margin-bottom: 8px; }
        .setup-modal p { color: var(--muted); font-size: 14px; margin-bottom: 20px; }
        .setup-modal input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .setup-modal button {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- Setup Modal (shown first time) -->
<div id="setup-overlay" class="setup-overlay" style="display:none;">
    <div class="setup-modal">
        <h2>Billing Dashboard Setup</h2>
        <p>Ingresa la URL del backend y tu JWT token para conectar al API de billing.</p>
        <input type="text" id="setup-url" placeholder="Backend URL (e.g. https://salesmate-wl.vercel.app)" />
        <input type="text" id="setup-token" placeholder="JWT Token (eyJ...)" />
        <button onclick="saveSetup()">Conectar</button>
    </div>
</div>

<div class="container">
    <header>
        <h1>Billing <span>Dashboard</span></h1>
        <div class="filters">
            <div>
                <label>Desde</label><br>
                <input type="date" id="filter-from" />
            </div>
            <div>
                <label>Hasta</label><br>
                <input type="date" id="filter-to" />
            </div>
            <div>
                <label>Agrupar</label><br>
                <select id="filter-group">
                    <option value="day">Día</option>
                    <option value="week">Semana</option>
                    <option value="month">Mes</option>
                </select>
            </div>
            <div style="align-self:flex-end;">
                <button onclick="fetchData()">Actualizar</button>
            </div>
        </div>
    </header>

    <div id="loading" class="loading-state" style="display:none;">
        <div class="spinner"></div>
        <p>Cargando datos de billing...</p>
    </div>

    <div id="error" class="error-state" style="display:none;">
        <p id="error-msg">Error al cargar datos</p>
        <button onclick="fetchData()">Reintentar</button>
        <button onclick="showSetup()" style="background: var(--border); margin-left: 8px;">Reconfigurar</button>
    </div>

    <div id="dashboard" style="display:none;">
        <!-- KPIs -->
        <section class="kpi-row">
            <div class="kpi-card">
                <div class="label">Verificaciones</div>
                <div class="value" id="kpi-total">0</div>
                <div class="sub" id="kpi-total-sub"></div>
            </div>
            <div class="kpi-card cost">
                <div class="label">Costo Estimado</div>
                <div class="value" id="kpi-cost">$0.00</div>
                <div class="sub" id="kpi-cost-sub"></div>
            </div>
            <div class="kpi-card pass">
                <div class="label">Aprobadas</div>
                <div class="value" id="kpi-passed">0</div>
                <div class="sub" id="kpi-pass-rate"></div>
            </div>
            <div class="kpi-card fail">
                <div class="label">Rechazadas</div>
                <div class="value" id="kpi-failed">0</div>
                <div class="sub" id="kpi-fail-sub"></div>
            </div>
            <div class="kpi-card">
                <div class="label">Tokens Totales</div>
                <div class="value" id="kpi-tokens">0</div>
                <div class="sub" id="kpi-tokens-sub"></div>
            </div>
            <div class="kpi-card">
                <div class="label">Tiempo Promedio</div>
                <div class="value" id="kpi-time">0s</div>
                <div class="sub">por verificación</div>
            </div>
        </section>

        <!-- Charts -->
        <section class="charts-grid">
            <div class="chart-card">
                <h3>Costo por Período</h3>
                <canvas id="chart-cost-time"></canvas>
            </div>
            <div class="chart-card">
                <h3>Distribución por Modelo</h3>
                <canvas id="chart-model-dist"></canvas>
            </div>
        </section>

        <section class="charts-grid">
            <div class="chart-card">
                <h3>Verificaciones por Período</h3>
                <canvas id="chart-verif-time"></canvas>
            </div>
            <div class="chart-card">
                <h3>Tokens por Modelo</h3>
                <canvas id="chart-tokens-model"></canvas>
            </div>
        </section>

        <!-- Tenants Table (admin) -->
        <section id="tenants-section" class="table-card" style="display:none; margin-bottom: 24px;">
            <h3>Desglose por Compañía (Tenant)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Compañía</th>
                        <th>Verificaciones</th>
                        <th>Aprobadas</th>
                        <th>Rechazadas</th>
                        <th>Tokens</th>
                        <th>Costo USD</th>
                    </tr>
                </thead>
                <tbody id="tenants-tbody"></tbody>
            </table>
        </section>

        <!-- Models Table -->
        <section class="table-card">
            <h3>Desglose por Modelo</h3>
            <table>
                <thead>
                    <tr>
                        <th>Modelo</th>
                        <th>Verificaciones</th>
                        <th>Input Tokens</th>
                        <th>Output Tokens</th>
                        <th>Tiempo Prom.</th>
                        <th>Costo USD</th>
                    </tr>
                </thead>
                <tbody id="models-tbody"></tbody>
            </table>
        </section>
    </div>

    <footer>
        Salesmate Photo Verification &mdash; Billing Dashboard
    </footer>
</div>

<script>
    // ── State ──
    let API_URL = localStorage.getItem('billing_api_url') || '';
    let API_TOKEN = localStorage.getItem('billing_api_token') || '';
    let charts = {};

    // ── Setup ──
    function showSetup() {
        document.getElementById('setup-url').value = API_URL;
        document.getElementById('setup-token').value = API_TOKEN;
        document.getElementById('setup-overlay').style.display = 'flex';
    }

    function saveSetup() {
        API_URL = document.getElementById('setup-url').value.replace(/\/$/, '');
        API_TOKEN = document.getElementById('setup-token').value;
        localStorage.setItem('billing_api_url', API_URL);
        localStorage.setItem('billing_api_token', API_TOKEN);
        document.getElementById('setup-overlay').style.display = 'none';
        fetchData();
    }

    // ── Defaults ──
    function initFilters() {
        const now = new Date();
        const from = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('filter-from').value = from.toISOString().split('T')[0];
        document.getElementById('filter-to').value = now.toISOString().split('T')[0];
    }

    // ── Fetch ──
    async function fetchData() {
        if (!API_URL || !API_TOKEN) { showSetup(); return; }

        const fromVal = document.getElementById('filter-from').value;
        const toVal = document.getElementById('filter-to').value;
        const groupBy = document.getElementById('filter-group').value;

        document.getElementById('loading').style.display = 'block';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('error').style.display = 'none';

        try {
            const url = `${API_URL}/api/billing?from=${fromVal}&to=${toVal}&groupBy=${groupBy}`;
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${API_TOKEN}` }
            });
            const json = await res.json();

            if (!json.success) throw new Error(json.error?.message || 'API error');

            renderDashboard(json.data);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        } catch (err) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-msg').textContent = err.message;
        }
    }

    // ── Render ──
    function renderDashboard(data) {
        const s = data.summary;

        // KPIs
        const total = Number(s.total_verifications) || 0;
        const cost = Number(s.total_cost_usd) || 0;
        const passed = Number(s.passed_count) || 0;
        const failed = Number(s.failed_count) || 0;
        const tokens = Number(s.total_tokens) || 0;
        const avgMs = Number(s.avg_processing_ms) || 0;

        document.getElementById('kpi-total').textContent = total.toLocaleString();
        document.getElementById('kpi-total-sub').textContent = `${data.period.from} — ${data.period.to}`;
        document.getElementById('kpi-cost').textContent = `$${cost.toFixed(4)}`;
        document.getElementById('kpi-cost-sub').textContent = total > 0 ? `~$${(cost / total).toFixed(6)} / verif.` : '';
        document.getElementById('kpi-passed').textContent = passed.toLocaleString();
        document.getElementById('kpi-pass-rate').textContent = total > 0 ? `${((passed / total) * 100).toFixed(1)}% tasa de aprobación` : '';
        document.getElementById('kpi-failed').textContent = failed.toLocaleString();
        document.getElementById('kpi-fail-sub').textContent = total > 0 ? `${((failed / total) * 100).toFixed(1)}% del total` : '';
        document.getElementById('kpi-tokens').textContent = formatTokens(tokens);
        document.getElementById('kpi-tokens-sub').textContent = `${formatTokens(Number(s.total_input_tokens) || 0)} in / ${formatTokens(Number(s.total_output_tokens) || 0)} out`;
        document.getElementById('kpi-time').textContent = avgMs > 1000 ? `${(avgMs / 1000).toFixed(1)}s` : `${avgMs}ms`;

        // Charts
        renderCostTimeChart(data.timeSeries);
        renderModelDistChart(data.byModel);
        renderVerifTimeChart(data.timeSeries);
        renderTokensModelChart(data.byModel);

        // Models table
        renderModelsTable(data.byModel);

        // Tenants table
        if (data.allTenants && data.allTenants.length > 0) {
            renderTenantsTable(data.allTenants);
            document.getElementById('tenants-section').style.display = 'block';
        } else {
            document.getElementById('tenants-section').style.display = 'none';
        }
    }

    function formatTokens(n) {
        if (n >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
        if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
        return n.toLocaleString();
    }

    // ── Chart Helpers ──
    const chartColors = {
        accent: '#6366f1',
        accentAlpha: 'rgba(99, 102, 241, 0.2)',
        green: '#22c55e',
        greenAlpha: 'rgba(34, 197, 94, 0.2)',
        red: '#ef4444',
        redAlpha: 'rgba(239, 68, 68, 0.2)',
        yellow: '#eab308',
        yellowAlpha: 'rgba(234, 179, 8, 0.2)',
        blue: '#3b82f6',
        blueAlpha: 'rgba(59, 130, 246, 0.2)',
        palette: ['#6366f1', '#22c55e', '#eab308', '#ef4444', '#3b82f6', '#a855f7', '#f97316'],
    };

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#8b8d97', font: { size: 12 } } } },
        scales: {
            x: { ticks: { color: '#8b8d97' }, grid: { color: 'rgba(42,45,58,0.5)' } },
            y: { ticks: { color: '#8b8d97' }, grid: { color: 'rgba(42,45,58,0.5)' } },
        },
    };

    function destroyChart(id) {
        if (charts[id]) { charts[id].destroy(); charts[id] = null; }
    }

    function renderCostTimeChart(timeSeries) {
        destroyChart('cost-time');
        const ctx = document.getElementById('chart-cost-time').getContext('2d');
        charts['cost-time'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: timeSeries.map(r => r.period),
                datasets: [{
                    label: 'Costo USD',
                    data: timeSeries.map(r => Number(r.cost_usd) || 0),
                    backgroundColor: chartColors.yellowAlpha,
                    borderColor: chartColors.yellow,
                    borderWidth: 1.5,
                    borderRadius: 4,
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    tooltip: {
                        callbacks: {
                            label: ctx => `$${Number(ctx.raw).toFixed(6)}`
                        }
                    }
                }
            }
        });
    }

    function renderModelDistChart(byModel) {
        destroyChart('model-dist');
        const ctx = document.getElementById('chart-model-dist').getContext('2d');
        charts['model-dist'] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: byModel.map(r => r.model_used),
                datasets: [{
                    data: byModel.map(r => Number(r.cost_usd) || 0),
                    backgroundColor: chartColors.palette.slice(0, byModel.length),
                    borderWidth: 0,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#8b8d97', font: { size: 12 }, padding: 16 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: $${Number(ctx.raw).toFixed(6)}`
                        }
                    }
                }
            }
        });
    }

    function renderVerifTimeChart(timeSeries) {
        destroyChart('verif-time');
        const ctx = document.getElementById('chart-verif-time').getContext('2d');
        charts['verif-time'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: timeSeries.map(r => r.period),
                datasets: [
                    {
                        label: 'Aprobadas',
                        data: timeSeries.map(r => Number(r.passed) || 0),
                        backgroundColor: chartColors.greenAlpha,
                        borderColor: chartColors.green,
                        borderWidth: 1.5,
                        borderRadius: 4,
                    },
                    {
                        label: 'Rechazadas',
                        data: timeSeries.map(r => Number(r.failed) || 0),
                        backgroundColor: chartColors.redAlpha,
                        borderColor: chartColors.red,
                        borderWidth: 1.5,
                        borderRadius: 4,
                    },
                ]
            },
            options: {
                ...commonOptions,
                scales: { ...commonOptions.scales, x: { ...commonOptions.scales.x, stacked: true }, y: { ...commonOptions.scales.y, stacked: true } }
            }
        });
    }

    function renderTokensModelChart(byModel) {
        destroyChart('tokens-model');
        const ctx = document.getElementById('chart-tokens-model').getContext('2d');
        charts['tokens-model'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: byModel.map(r => r.model_used),
                datasets: [
                    {
                        label: 'Input Tokens',
                        data: byModel.map(r => Number(r.input_tokens) || 0),
                        backgroundColor: chartColors.blueAlpha,
                        borderColor: chartColors.blue,
                        borderWidth: 1.5,
                        borderRadius: 4,
                    },
                    {
                        label: 'Output Tokens',
                        data: byModel.map(r => Number(r.output_tokens) || 0),
                        backgroundColor: chartColors.accentAlpha,
                        borderColor: chartColors.accent,
                        borderWidth: 1.5,
                        borderRadius: 4,
                    },
                ]
            },
            options: {
                ...commonOptions,
                indexAxis: 'y',
                scales: {
                    x: { ...commonOptions.scales.x, stacked: true },
                    y: { ...commonOptions.scales.y, stacked: true },
                }
            }
        });
    }

    // ── Tables ──
    function renderModelsTable(byModel) {
        const tbody = document.getElementById('models-tbody');
        tbody.innerHTML = byModel.map(r => `
            <tr>
                <td><strong>${r.model_used}</strong></td>
                <td class="num">${Number(r.verifications).toLocaleString()}</td>
                <td class="num">${formatTokens(Number(r.input_tokens))}</td>
                <td class="num">${formatTokens(Number(r.output_tokens))}</td>
                <td class="num">${Number(r.avg_ms) > 1000 ? (Number(r.avg_ms) / 1000).toFixed(1) + 's' : r.avg_ms + 'ms'}</td>
                <td class="cost">$${Number(r.cost_usd).toFixed(6)}</td>
            </tr>
        `).join('');
    }

    function renderTenantsTable(allTenants) {
        const tbody = document.getElementById('tenants-tbody');
        tbody.innerHTML = allTenants.map(r => `
            <tr>
                <td><strong>${r.tenant_name}</strong> <span style="color:var(--muted)">(${r.tenant_slug})</span></td>
                <td class="num">${Number(r.verifications).toLocaleString()}</td>
                <td class="num" style="color:var(--green)">${Number(r.passed).toLocaleString()}</td>
                <td class="num" style="color:var(--red)">${Number(r.failed).toLocaleString()}</td>
                <td class="num">${formatTokens(Number(r.input_tokens) + Number(r.output_tokens))}</td>
                <td class="cost">$${Number(r.cost_usd).toFixed(6)}</td>
            </tr>
        `).join('');
    }

    // ── Init ──
    initFilters();
    if (!API_URL || !API_TOKEN) {
        showSetup();
    } else {
        fetchData();
    }
</script>
</body>
</html>
